{% extends "base.html" %}

{% block title %}System Health — StreamForge{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold text-surface-900">System Health</h1>
        <p class="text-surface-500 mt-1">Monitor the status of all services and dependencies.</p>
    </div>

    <!-- Overall status card -->
    <div id="overall-status" class="card p-6">
        <div class="flex items-center gap-4">
            <div id="status-indicator" class="w-4 h-4 rounded-full bg-surface-300 animate-pulse"></div>
            <div>
                <h2 id="status-text" class="text-lg font-semibold text-surface-700">Checking...</h2>
                <p id="status-sub" class="text-sm text-surface-500">Running health checks</p>
            </div>
        </div>
    </div>

    <!-- Service checks grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- API Server -->
        <div class="card p-5 space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-brand-50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-surface-900">API Server</p>
                        <p class="text-xs text-surface-500">FastAPI + Uvicorn</p>
                    </div>
                </div>
                <span id="badge-api" class="px-2.5 py-1 rounded-full text-xs font-medium bg-surface-100 text-surface-500">Checking</span>
            </div>
            <p id="detail-api" class="text-sm text-surface-500">—</p>
        </div>

        <!-- FFmpeg -->
        <div class="card p-5 space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-surface-900">FFmpeg</p>
                        <p class="text-xs text-surface-500">Video processing engine</p>
                    </div>
                </div>
                <span id="badge-ffmpeg" class="px-2.5 py-1 rounded-full text-xs font-medium bg-surface-100 text-surface-500">Checking</span>
            </div>
            <p id="detail-ffmpeg" class="text-sm text-surface-500">—</p>
        </div>

        <!-- Disk Space -->
        <div class="card p-5 space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-surface-900">Storage</p>
                        <p class="text-xs text-surface-500">Disk usage</p>
                    </div>
                </div>
                <span id="badge-disk" class="px-2.5 py-1 rounded-full text-xs font-medium bg-surface-100 text-surface-500">Checking</span>
            </div>
            <p id="detail-disk" class="text-sm text-surface-500">—</p>
        </div>

        <!-- Database -->
        <div class="card p-5 space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-surface-900">Database</p>
                        <p class="text-xs text-surface-500">SQLite</p>
                    </div>
                </div>
                <span id="badge-db" class="px-2.5 py-1 rounded-full text-xs font-medium bg-surface-100 text-surface-500">Checking</span>
            </div>
            <p id="detail-db" class="text-sm text-surface-500">—</p>
        </div>
    </div>

    <!-- Refresh button -->
    <div class="flex justify-center">
        <button onclick="runHealthCheck()" class="btn-secondary flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
        </button>
    </div>
</div>

<script>
function setBadge(id, status, text) {
    const el = document.getElementById(id);
    el.textContent = text;
    el.className = 'px-2.5 py-1 rounded-full text-xs font-medium ';
    if (status === 'ok') el.className += 'bg-green-100 text-green-700';
    else if (status === 'warn') el.className += 'bg-amber-100 text-amber-700';
    else el.className += 'bg-red-100 text-red-700';
}

async function runHealthCheck() {
    // Reset
    document.getElementById('status-indicator').className = 'w-4 h-4 rounded-full bg-surface-300 animate-pulse';
    document.getElementById('status-text').textContent = 'Checking...';
    document.getElementById('status-sub').textContent = 'Running health checks';

    try {
        const res = await fetch('/api/health/detailed');
        const data = await res.json();

        // API
        setBadge('badge-api', 'ok', 'Healthy');
        document.getElementById('detail-api').textContent = `Response time: ${data.response_time_ms}ms`;

        // FFmpeg
        if (data.ffmpeg.available) {
            setBadge('badge-ffmpeg', 'ok', 'Installed');
            document.getElementById('detail-ffmpeg').textContent = data.ffmpeg.version || 'Available';
        } else {
            setBadge('badge-ffmpeg', 'error', 'Missing');
            document.getElementById('detail-ffmpeg').textContent = 'ffmpeg not found in PATH';
        }

        // Disk
        const diskPct = data.disk.used_percent;
        const diskStatus = diskPct > 90 ? 'error' : diskPct > 75 ? 'warn' : 'ok';
        const diskLabel = diskPct > 90 ? 'Critical' : diskPct > 75 ? 'Warning' : 'OK';
        setBadge('badge-disk', diskStatus, diskLabel);
        document.getElementById('detail-disk').textContent =
            `${data.disk.free_gb} GB free of ${data.disk.total_gb} GB (${diskPct}% used)`;

        // DB
        if (data.database.connected) {
            setBadge('badge-db', 'ok', 'Connected');
            document.getElementById('detail-db').textContent =
                `Presets: ${data.database.presets_count} | Share tokens: ${data.database.share_tokens_count}`;
        } else {
            setBadge('badge-db', 'error', 'Error');
            document.getElementById('detail-db').textContent = data.database.error || 'Connection failed';
        }

        // Overall
        const allOk = data.ffmpeg.available && data.database.connected && diskPct < 90;
        document.getElementById('status-indicator').className =
            'w-4 h-4 rounded-full ' + (allOk ? 'bg-green-500' : 'bg-amber-500');
        document.getElementById('status-text').textContent = allOk ? 'All Systems Operational' : 'Degraded';
        document.getElementById('status-sub').textContent = `Last checked: ${new Date().toLocaleTimeString()}`;

    } catch (e) {
        document.getElementById('status-indicator').className = 'w-4 h-4 rounded-full bg-red-500';
        document.getElementById('status-text').textContent = 'API Unreachable';
        document.getElementById('status-sub').textContent = e.message;
        setBadge('badge-api', 'error', 'Down');
        document.getElementById('detail-api').textContent = 'Could not connect to API server';
    }
}

// Run on page load
runHealthCheck();
</script>
{% endblock %}
