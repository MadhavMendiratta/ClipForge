{% extends "base.html" %}

{% block title %}Upload Video — StreamForge{% endblock %}
{% block page_title %}Upload Video{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto fade-in">
    <form id="uploadForm" enctype="multipart/form-data" class="space-y-6">
        <!-- Row 1: Upload + AI Editing side by side -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Video Upload Card -->
            <div class="bg-white rounded-2xl border border-surface-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-surface-100">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        <h2 class="text-sm font-semibold text-surface-800">Video File</h2>
                    </div>
                </div>
                <div class="p-6">
                    <div id="dropZone" class="drop-zone border-2 border-dashed border-surface-300 rounded-xl p-8 text-center cursor-pointer hover:border-brand-400 hover:bg-brand-50/30 transition-all">
                        <div id="dropZoneContent">
                            <svg class="w-10 h-10 text-surface-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            <p class="text-sm font-medium text-surface-700 mb-1">Drop your video here</p>
                            <p class="text-xs text-surface-400">or click to browse · MP4, AVI, MOV, MKV · Max 500MB</p>
                        </div>
                        <div id="fileInfo" class="hidden">
                            <svg class="w-10 h-10 text-emerald-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <p class="text-sm font-medium text-surface-800" id="fileName">video.mp4</p>
                            <p class="text-xs text-surface-400" id="fileSize">12.4 MB</p>
                            <button type="button" onclick="clearFile()" class="mt-2 text-xs text-red-500 hover:text-red-700 font-medium">Remove</button>
                        </div>
                        <input type="file" name="video" id="videoInput" accept="video/*" class="hidden" required>
                    </div>
                    <!-- Upload progress (shown during upload) -->
                    <div id="uploadProgressWrap" class="hidden mt-4">
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="text-xs font-medium text-surface-600">Uploading...</span>
                            <span class="text-xs font-medium text-brand-600" id="uploadPercent">0%</span>
                        </div>
                        <div class="w-full h-2 bg-surface-100 rounded-full overflow-hidden">
                            <div id="uploadBar" class="h-full bg-brand-500 rounded-full progress-animate" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Editing Card -->
            <div class="bg-white rounded-2xl border border-surface-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-surface-100">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        <h2 class="text-sm font-semibold text-surface-800">AI Editing</h2>
                        <span class="text-[10px] font-medium bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded-full">Optional</span>
                    </div>
                </div>
                <div class="p-6">
                    <label class="block text-xs font-medium text-surface-600 mb-2">Describe edits in plain English</label>
                    <textarea name="edit_text" id="editText" rows="5"
                        class="w-full px-3.5 py-2.5 text-sm border border-surface-200 rounded-xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all resize-none placeholder:text-surface-400"
                        placeholder="Cut first 10 seconds, speed up the middle part 1.5x, and add a 3 second fade out at the end..."></textarea>
                    <p class="mt-2 text-[11px] text-surface-400">
                        Supports: <span class="font-mono text-surface-500">trim_start</span> · <span class="font-mono text-surface-500">trim_end</span> · <span class="font-mono text-surface-500">speed</span> · <span class="font-mono text-surface-500">fade_out</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Row 2: Processing Options + Preset side by side -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Processing Options Card -->
            <div class="bg-white rounded-2xl border border-surface-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-surface-100">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <h2 class="text-sm font-semibold text-surface-800">Processing Options</h2>
                    </div>
                </div>
                <div class="p-6 space-y-5">
                    <!-- Silence Removal Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-surface-800">Remove silence</p>
                            <p class="text-xs text-surface-400 mt-0.5">Auto-detect and cut silent segments</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="remove_silence" id="removeSilence" value="true">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <!-- Face Crop Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-surface-800">Auto-crop to face</p>
                            <p class="text-xs text-surface-400 mt-0.5">Crop to 9:16 vertical centered on face</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="auto_crop_face" id="autoCropFace" value="true">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Preset Selector Card -->
            <div class="bg-white rounded-2xl border border-surface-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-surface-100">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        <h2 class="text-sm font-semibold text-surface-800">Preset</h2>
                        <span class="text-[10px] font-medium bg-teal-100 text-teal-700 px-1.5 py-0.5 rounded-full">Optional</span>
                    </div>
                </div>
                <div class="p-6">
                    <label class="block text-xs font-medium text-surface-600 mb-2">Apply a saved preset</label>
                    <select name="preset_id" id="presetSelect"
                        class="w-full px-3.5 py-2.5 text-sm border border-surface-200 rounded-xl focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all bg-white appearance-none"
                        style="background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M7%207l3%203%203-3%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 12px center;">
                        <option value="">None — use manual settings</option>
                    </select>
                    <div id="presetInfo" class="hidden mt-3 p-3 bg-teal-50 rounded-lg border border-teal-100">
                        <p class="text-xs font-medium text-teal-800" id="presetInfoText"></p>
                    </div>
                    <a href="/presets" class="inline-flex items-center gap-1 mt-3 text-xs text-brand-600 hover:text-brand-700 font-medium">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Manage presets
                    </a>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
            <button type="submit" id="submitBtn"
                class="inline-flex items-center gap-2 px-6 py-3 bg-brand-600 hover:bg-brand-700 text-white text-sm font-semibold rounded-xl shadow-sm hover:shadow transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/></svg>
                <span id="submitBtnText">Upload & Process</span>
                <svg id="submitSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load presets into dropdown
    async function loadPresets() {
        try {
            const res = await fetch('/api/presets');
            if (!res.ok) return;
            const presets = await res.json();
            const sel = document.getElementById('presetSelect');
            presets.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                opt.dataset.config = JSON.stringify(p.config_json);
                opt.dataset.desc = p.description;
                sel.appendChild(opt);
            });
        } catch (e) { console.warn('Could not load presets', e); }
    }

    document.getElementById('presetSelect').addEventListener('change', function() {
        const opt = this.selectedOptions[0];
        const info = document.getElementById('presetInfo');
        const infoText = document.getElementById('presetInfoText');
        if (this.value && opt.dataset.config) {
            const cfg = JSON.parse(opt.dataset.config);
            const parts = [];
            if (cfg.remove_silence) parts.push('Silence removal');
            if (cfg.auto_crop_face) parts.push('Face crop');
            if (cfg.edit_text) parts.push('AI Edit: "' + cfg.edit_text.slice(0, 60) + '"');
            infoText.textContent = (opt.dataset.desc || '') + (parts.length ? ' — ' + parts.join(', ') : '');
            info.classList.remove('hidden');
        } else {
            info.classList.add('hidden');
        }
    });

    loadPresets();

    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    const videoInput = document.getElementById('videoInput');

    dropZone.addEventListener('click', () => videoInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
            videoInput.files = e.dataTransfer.files;
            showFileInfo(e.dataTransfer.files[0]);
        }
    });
    videoInput.addEventListener('change', () => {
        if (videoInput.files.length) showFileInfo(videoInput.files[0]);
    });

    function showFileInfo(file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatBytes(file.size);
        document.getElementById('dropZoneContent').classList.add('hidden');
        document.getElementById('fileInfo').classList.remove('hidden');
    }

    function clearFile() {
        videoInput.value = '';
        document.getElementById('dropZoneContent').classList.remove('hidden');
        document.getElementById('fileInfo').classList.add('hidden');
    }

    function formatBytes(b) {
        if (b === 0) return '0 B';
        const k = 1024, s = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(b) / Math.log(k));
        return parseFloat((b / Math.pow(k, i)).toFixed(1)) + ' ' + s[i];
    }

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = this;
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('submitBtnText');
        const spinner = document.getElementById('submitSpinner');
        const progWrap = document.getElementById('uploadProgressWrap');
        const progBar = document.getElementById('uploadBar');
        const progPct = document.getElementById('uploadPercent');

        if (!videoInput.files.length) {
            window.showToast('Please select a video file', 'error');
            return;
        }

        btn.disabled = true;
        btnText.textContent = 'Uploading...';
        spinner.classList.remove('hidden');
        progWrap.classList.remove('hidden');

        const formData = new FormData(form);
        // Remove unchecked checkboxes from FormData
        if (!document.getElementById('removeSilence').checked) formData.delete('remove_silence');
        if (!document.getElementById('autoCropFace').checked) formData.delete('auto_crop_face');
        // Remove empty optional fields
        if (!formData.get('edit_text')?.trim()) formData.delete('edit_text');
        if (!formData.get('preset_id')) formData.delete('preset_id');

        try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/upload');

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    progBar.style.width = pct + '%';
                    progPct.textContent = pct + '%';
                }
            });

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const result = JSON.parse(xhr.responseText);
                    window.showToast('Video uploaded! Processing started...', 'success');
                    setTimeout(() => {
                        window.location.href = '/video/' + result.video_id;
                    }, 500);
                } else {
                    let msg = 'Upload failed';
                    try { msg = JSON.parse(xhr.responseText).detail || msg; } catch(e) {}
                    window.showToast(msg, 'error');
                    resetBtn();
                }
            };

            xhr.onerror = function() {
                window.showToast('Network error during upload', 'error');
                resetBtn();
            };

            xhr.send(formData);
        } catch (err) {
            window.showToast('Upload failed: ' + err.message, 'error');
            resetBtn();
        }

        function resetBtn() {
            btn.disabled = false;
            btnText.textContent = 'Upload & Process';
            spinner.classList.add('hidden');
            progWrap.classList.add('hidden');
            progBar.style.width = '0%';
        }
    });
</script>
{% endblock %}
